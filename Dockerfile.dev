# Dockerfile.dev (recomendado para dev)
FROM node:20-bookworm-slim

# Toolchain mínima para paquetes nativos (sharp/canvas/etc.)
RUN apt-get update && apt-get install -y --no-install-recommends \
    g++ make python3 git ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# --- Ajustes npm para acelerar y evitar cuelgues ---
ENV \
    NODE_ENV=development \
    NEXT_TELEMETRY_DISABLED=1 \
    NPM_CONFIG_FUND=false \
    NPM_CONFIG_AUDIT=false \
    NPM_CONFIG_PROGRESS=false \
    NPM_CONFIG_UPDATE_NOTIFIER=false \
    NPM_CONFIG_FETCH_RETRIES=5 \
    NPM_CONFIG_FETCH_RETRY_FACTOR=2 \
    NPM_CONFIG_FETCH_RETRY_MINTIMEOUT=20000 \
    NPM_CONFIG_FETCH_RETRY_MAXTIMEOUT=120000

# Copiamos solo manifests para cachear deps
COPY package.json ./
COPY package-lock.json ./
# Si usas yarn/pnpm, copia su lock en vez de package-lock

# >>> Requiere BuildKit para cache mount <<<
# Habilita BuildKit al construir: DOCKER_BUILDKIT=1
# Cache de ~/.npm acelera instalaciones y reduce cuelgues por red intermitente
RUN --mount=type=cache,target=/root/.npm npm ci --include=dev

# Ahora sí, tu código
COPY . .

EXPOSE 3000
ENV NODE_OPTIONS=--max-old-space-size=1024
CMD ["npm","run","dev"]